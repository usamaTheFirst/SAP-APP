@page "/leave"


@inject IToastService toastService
@inject AuthenticationStateProvider AuthNStateProvider
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore;
@using Microsoft.Extensions.Options;
@using SAPConnection.Areas.Identity.Data;
@using SAPConnection.Data;
@inject IHttpContextAccessor httpContextAccessor

@inject UserManager<ApplicationUser> userManager
@inject IHttpContextAccessor httpContextAccessor
@inject Microsoft.EntityFrameworkCore.DbContextOptions<SAPConnectionContext> dbContextOptions





<center><h1 style="font-family:Georgia; font-size:x-large;">Leave Application Form</h1></center>
<form>
    <table cellpadding="14" width=100%>
        <tr style="background-color: #000080; color: white; font-weight:500; font-size:larger">
            <td colspan="4">
                <label>Employee Details</label>
            </td>
        </tr>
        <tr width=100%>
            <td width= 20%>
                <label>Request Date : </label>
            </td>
            <td width = 30%>
                <span data-date-time="@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss %")"></span>
            </td>
            <td width = 20%>
                <label> Status : </label>
            </td>
            <td width = 30%>
                <input type="text" readonly value="Draft" size="35" />
            </td>
        </tr>
        <tr>
            <td>
                <label>Employee Name : </label>
            </td>
            <td>
                <input type="text" readonly value="@Name" size="35"/>
            </td>
            <td>
                <label>Employee Number : </label>
            </td>
            <td>
                <input type="text" readonly value="@Pno" size="35" />
            </td>
        </tr>
        <tr>
            <td>
                <label>Department : </label>
            </td>
            <td>
                <input type="text" readonly value="@Department" size="35" />
            </td>
            <td>
                <label>Designation : </label>
            </td>
            <td>
                <input type="text" readonly value="@Designation" size="35" />
            </td>
        </tr>
        <tr style="background-color: #000080; color: white; font-weight:500; font-size:larger">
            <td colspan="4">
                <label>Leave Details</label>
            </td>
        </tr>
        <tr>
            <td>
                <label>Leave Type : </label>
            </td>
            <td>
               <select style="width:100%;">
                    <option>Casual</option>
                    <option>Sick</option>
                    <option>Annual</option>
               </select>
            </td>
            <td>
                <label>Leave Balance : </label>
            </td>
            <td>
                <input type="text" readonly size="35" />
            </td>
        </tr>
        <tr>
            <td>
                <label>Leave From : </label>
            </td>
            <td>
                <input type="date" size="35" />
            </td>
            <td>
                <label>Leave To : </label>
            </td>
            <td>
                <input type="date" size="35" />
            </td>
        </tr>
        <tr>
            <td>
                <label>Reason For Leave : </label>
            </td>
            <td colspan="3">
                <textarea style="width:100%"></textarea>
            </td>
        </tr>
        <tr>
            <td>
                <label>Attachments</label>
            </td>
            <td colspan="3">
                <input name = "attachment" type="file" multiple/>
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>
                <input style="background-color:#000080; color:white; font-size:large; border-radius:5px; width:50%; float:right;"  type="submit"/>
            </td>
        </tr>
        </table>
        
        <div>
            <div style="width:10px;">
                <div onclick="show()" 
                    style="border:1px solid black;
                    float:left;
                    font-size:large; 
                    width: 0;
	                height: 0;
	                border-top: 8px solid transparent;
	                border-left: 16px solid #555;
	                border-bottom: 8px solid transparent;
                ">
                </div>
            </div>
            <div  colspan="4"  style="margin-left:30px;">
            <button @onclick="@Show"><b id="approve_route" style="cursor:pointer;">Approval Route</b></button>
            </div>
        </div>
        <br />
    <table style="width:100%;" hidden="@IsShow">
        <tr>
            <td colspan="4">
                <div id="route_details" style="width:100%">
                    
                    <table style="width:100%; text-align:center;">
                        <tr>
                            <td colspan="5" style="background-color:#000080; color:white; text-align:center;">
                                Approval Route Detail
                            </td>
                        </tr>
                        <tr style="border:1px solid black;">
                            <th style="border:1px solid black;">
                                <label>Level</label>
                            </th>
                            <th  style="border:1px solid black;">
                                <label>Task</label>
                            </th>
                            <th colspan="3"  style="border:1px solid black; text-align:right; padding-right: 150px;">
                                <label>Approver</label>
                            </th>
                        </tr>
                        <tr style="border:1px solid black;">
                            <th style="border:1px solid black;">
                                <label>1.</label>
                            </th>
                            <td  style="border:1px solid black;">
                                <label>Review</label>
                            </td>
                            <td colspan="3"  style="border:1px solid black; text-align:right; padding-right: 100px;">
                                <label>naeem iqbal/it/ho/ffbl</label>
                            </td>
                        </tr>
                        <tr style="border:1px solid black;">
                            <th style="border:1px solid black;">
                                <label>2.</label>
                            </th>
                            <td  style="border:1px solid black;">
                                <label>Approve</label>
                            </td>
                            <td colspan="3"  style="border:1px solid black; text-align:right; padding-right: 100px;">
                                <label>sajid malik/it/ho/ffbl</label>
                            </td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
    <br />
</form>

@code {
    private static bool IsShow { get; set; } = true;

    string Name;
    string Designation;
    string Department;
    string Pno;
    string Date;
    private void Show()
    {
        IsShow = !IsShow;
    }



    protected override async Task OnInitializedAsync()
    {

        var user = await userManager.GetUserAsync(httpContextAccessor.HttpContext.User);

        using var context = new SAPConnectionContext(dbContextOptions);

        var pno = await context.Users
            .Where(u => u.Id == user.Id)
            .Select(u => u.Pno)
            .FirstOrDefaultAsync();
        Pno = pno.ToString();
        string connectionString = "AppServerHost=10.1.25.168; SystemNumber=00; User=abapdev; Password=Ffbl@786#; Client=300; Language=EN; PoolSize=5; Trace=8";

        using var connection = new SapNwRfc.SapConnection(connectionString);

        connection.Connect();
        var someFunction = connection.CreateFunction("ZBAPI_EMP_PRSNL_DETAILS");
        var result = someFunction.Invoke<SAPRFCResult>(new SAPInputParameter
            {
                Pno = Pno,
            });

        try
        {

            Name = result.Items[0].Name.ToString();
            Designation = result.Items[0].Designation.ToString();
            Department = result.Items[0].Department.ToString();
            Pno = result.Items[0].Pno.ToString();
            Date = DateTime.Now.Date.ToString();

        }
        catch (Exception e)
        {
            toastService.ShowError("No Record exists against the entered P.Number.");
        }





    }


}
